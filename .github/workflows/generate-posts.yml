name: Auto-generate blogpost HTML files

on:
  push:
    paths:
      - "blogpost/*.md"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Generate HTML from markdown template
        run: |
          import os, re, shutil

          BASE_DIR = "blogpost"
          TEMPLATE = os.path.join(BASE_DIR, "template.html")
          POSTLIST = os.path.join(BASE_DIR, "POSTLIST.txt")

          # Load existing posts list (if exists)
          existing_posts = []
          if os.path.exists(POSTLIST):
              with open(POSTLIST, "r") as f:
                  existing_posts = [line.strip() for line in f if line.strip()]

          for fname in os.listdir(BASE_DIR):
              if not fname.endswith(".md") or fname == "template.md":
                  continue

              post_name = os.path.splitext(fname)[0]
              md_path = os.path.join(BASE_DIR, fname)
              html_path = os.path.join(BASE_DIR, f"{post_name}.html")

              # Copy and modify template
              with open(TEMPLATE, "r") as f:
                  html = f.read()

              # Replace placeholders
              html = html.replace("catFile('post.md')", f"catFile('{fname}')")
              html = html.replace("[POST_TITLE]", post_name)
              html = html.replace("[POST_SLUG]", post_name)
              html = html.replace("[POST_DESCRIPTION - A short snippet of the post content]", f"{post_name} blog post")

              with open(html_path, "w") as f:
                  f.write(html)

              # Add to POSTLIST.txt if missing
              if post_name not in existing_posts:
                  existing_posts.append(post_name)

          # Write updated post list (sorted)
          with open(POSTLIST, "w") as f:
              f.write("\n".join(sorted(existing_posts)) + "\n")

      - name: Commit and push results
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add blogpost/*.html blogpost/POSTLIST.txt
          git commit -m "Auto-generate new post HTML files" || echo "No changes to commit"
          git push
